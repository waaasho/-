<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>é«˜çŸ¥ ç¥ç¤¾æ¢è¨ªãƒãƒƒãƒ— V2</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; background: #f0f2f5; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        
        /* ã‚¹ãƒãƒ›å‘ã‘æ“ä½œãƒ‘ãƒãƒ« */
        .ui-panel {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            z-index: 1000; width: 95%; max-width: 400px;
            background: rgba(255, 255, 255, 0.95); padding: 8px 12px;
            border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        .popup-img { width: 100%; height: 150px; object-fit: cover; border-radius: 6px; margin-bottom: 8px; }
        .loading-spinner { display: none; margin-left: 10px; }
        
        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å†…ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .leaflet-popup-content { margin: 10px; width: 260px !important; }
        .comment-section { background: #f8f9fa; padding: 8px; border-radius: 6px; margin-top: 10px; font-size: 0.9rem; }
        .saved-comment { border-bottom: 1px solid #dee2e6; padding-bottom: 4px; margin-bottom: 4px; color: #333; }
        .no-comment { color: #777; font-style: italic; font-size: 0.8rem; }
        .btn-google { background-color: #4285F4; color: white; border: none; }
        .btn-google:hover { background-color: #357abd; color: white; }
    </style>
</head>
<body>

<div class="ui-panel">
    <div class="d-flex align-items-center justify-content-between">
        <select id="city-select" class="form-select form-select-sm me-2" style="flex-grow: 1;">
          <option value="é«˜çŸ¥çœŒ">é«˜çŸ¥çœŒ å…¨åŸŸ (ä½é€Ÿ)</option>
            <option value="é«˜çŸ¥å¸‚" selected>é«˜çŸ¥å¸‚</option>
            <option value="å—å›½å¸‚">å—å›½å¸‚</option>
            <option value="å››ä¸‡åå¸‚">å››ä¸‡åå¸‚</option>
          <option value="å››ä¸‡åç”º">å››ä¸‡åç”º</option>
            <option value="é¦™å—å¸‚">é¦™å—å¸‚</option>
          <option value="é¦™ç¾å¸‚">é¦™ç¾å¸‚</option>
            <option value="åœŸä½å¸‚">åœŸä½å¸‚</option>
            <option value="å®¤æˆ¸å¸‚">å®¤æˆ¸å¸‚</option>
            <option value="å®‰èŠ¸å¸‚">å®‰èŠ¸å¸‚</option>
            <option value="å®¿æ¯›å¸‚">å®¿æ¯›å¸‚</option>
            <option value="åœŸä½æ¸…æ°´å¸‚">åœŸä½æ¸…æ°´å¸‚</option>
            <option value="é ˆå´å¸‚">é ˆå´å¸‚</option>
            <option value="ã„ã®ç”º">ã„ã®ç”º</option>
          ã€€<option value="ä½å·ç”º">ä½å·ç”º</option>
            <option value="æ±æ´‹ç”º">æ±æ´‹ç”º</option>
          <option value="å¥ˆåŠåˆ©ç”º">å¥ˆåŠåˆ©ç”º</option>
          <option value="ç”°é‡ç”º">ç”°é‡ç”º</option>
          <option value="å®‰ç”°ç”º">å®‰ç”°ç”º</option>
          <option value="åŒ—å·æ‘">åŒ—å·æ‘</option>
          <option value="é¦¬è·¯æ‘">é¦¬è·¯æ‘</option>
          <option value="èŠ¸è¥¿æ‘">èŠ¸è¥¿æ‘</option>
          <option value="æœ¬å±±ç”º">æœ¬å±±ç”º</option>
          <option value="å¤§è±Šç”º">å¤§è±Šç”º</option>
          <option value="åœŸä½ç”º">åœŸä½ç”º</option>
          <option value="å¤§å·æ‘">å¤§å·æ‘</option>
          <option value="ä»æ·€å·ç”º">ä»æ·€å·ç”º</option>
          <option value="ä¸­åœŸä½ç”º">ä¸­åœŸä½ç”º</option>
          <option value="è¶ŠçŸ¥ç”º">è¶ŠçŸ¥ç”º</option>
          <option value="æª®åŸç”º">æª®åŸç”º</option>
          <option value="æ—¥é«˜æ‘">æ—¥é«˜æ‘</option>
          <option value="æ´¥é‡ç”º">æ´¥é‡ç”º</option>
          <option value="å¤§æœˆç”º">å¤§æœˆç”º</option>
          <option value="ä¸‰åŸç”º">ä¸‰åŸç”º</option>
          <option value="é»’æ½®ç”º">é»’æ½®ç”º</option>
       
        </select>
        <button class="btn btn-primary btn-sm text-nowrap px-3" onclick="fetchShrines()">æ¤œç´¢</button>
        <div id="spinner" class="spinner-border spinner-border-sm text-primary loading-spinner"></div>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const map = L.map('map', { zoomControl: false }).setView([33.5597, 133.5311], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OSM contributors' }).addTo(map);
    L.control.zoom({ position: 'bottomright' }).addTo(map);
    const markerGroup = L.layerGroup().addTo(map);

    // â›©ï¸ é³¥å±…ã‚¢ã‚¤ã‚³ãƒ³ã®å®šç¾© (Data URIã§ç”»åƒã‚’åŸ‹ã‚è¾¼ã¿)
    const toriiIcon = L.icon({
        iconUrl: 'data:image/svg+xml;charset=utf-8,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"%3E%3Cpath fill="%23d63031" d="M106.7 32h298.6v42.7H106.7zM21.3 74.7h469.4v64H21.3z"/%3E%3Cpath fill="%23d63031" d="M85.3 74.7h64v416h-64zM362.7 74.7h64v416h-64z"/%3E%3Cpath fill="%23d63031" d="M85.3 181.3h341.4v53.3H85.3z"/%3E%3C/svg%3E',
        iconSize: [40, 40], // ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚µã‚¤ã‚º
        iconAnchor: [20, 40], // ã‚¢ã‚¤ã‚³ãƒ³ã®å…ˆç«¯ä½ç½®
        popupAnchor: [0, -38] // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒå‡ºã‚‹ä½ç½®
    });

    async function fetchShrines() {
        const cityName = document.getElementById('city-select').value;
        document.getElementById('spinner').style.display = 'inline-block';
        markerGroup.clearLayers();

        // Overpass API ã‚¯ã‚¨ãƒª (ç¥é“ã®ã¿å¯¾è±¡)
        const query = `[out:json][timeout:30];area["name"="${cityName}"]->.a;(node["amenity"="place_of_worship"]["religion"="shinto"](area.a);way["amenity"="place_of_worship"]["religion"="shinto"](area.a););out center;`;

        try {
            const res = await fetch("https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query));
            const data = await res.json();
            
            if (data.elements.length === 0) alert("ç¥ç¤¾ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");

            data.elements.forEach(el => {
                const lat = el.lat || el.center.lat;
                const lon = el.lon || el.center.lon;
                const name = el.tags.name || "åç§°ä¸æ˜ã®ç¥ç¤¾";
                const shrineId = `shrine_${lat}_${lon}`; // ã‚³ãƒ¡ãƒ³ãƒˆä¿å­˜ç”¨ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ID

                // å†™çœŸ (WikimediaãŒã‚ã‚Œã°è¡¨ç¤º)
                let photoHtml = "";
                if (el.tags.wikimedia_commons) {
                    const imgUrl = `https://commons.wikimedia.org/wiki/Special:FilePath/${el.tags.wikimedia_commons.replace('File:', '')}?width=300`;
                    photoHtml = `<img src="${imgUrl}" class="popup-img" alt="${name}">`;
                }

                // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®å†…å®¹ã‚’æ§‹ç¯‰
                const popupContent = document.createElement('div');
                popupContent.innerHTML = `
                    <h6 class="fw-bold mb-2">${name}</h6>
                    ${photoHtml}
                    <div class="d-grid gap-2 mb-3">
                        <a href="https://www.google.com/maps/search/?api=1&query=${name}+é«˜çŸ¥çœŒ" target="_blank" class="btn btn-google btn-sm">
                            <i class="bi bi-google"></i> Googleãƒãƒƒãƒ—ã§å†™çœŸã‚’è¦‹ã‚‹
                        </a>
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" target="_blank" class="btn btn-outline-primary btn-sm">
                           ğŸ“ã“ã“ã¸ã®ãƒ«ãƒ¼ãƒˆæ¡ˆå†…
                        </a>
                    </div>
                    <div class="comment-section">
                        <strong>è‡ªåˆ†ã®ãƒ¡ãƒ¢:</strong>
                        <div id="comment-display-${shrineId}" class="mb-2 mt-1"></div>
                        <textarea id="comment-input-${shrineId}" class="form-control form-control-sm" rows="2" placeholder="ã“ã“ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..."></textarea>
                        <button class="btn btn-secondary btn-sm w-100 mt-2" onclick="saveComment('${shrineId}')">ä¿å­˜ã™ã‚‹</button>
                    </div>
                `;

                const marker = L.marker([lat, lon], { icon: toriiIcon }) // é³¥å±…ã‚¢ã‚¤ã‚³ãƒ³ã‚’é©ç”¨
                    .bindPopup(popupContent);
                
                // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã„ãŸæ™‚ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã‚€
                marker.on('popupopen', () => loadComment(shrineId));
                markerGroup.addLayer(marker);
            });

            if (markerGroup.getLayers().length > 0) map.fitBounds(markerGroup.getBounds(), { padding: [50, 50] });

        } catch (e) {
            console.error(e); alert("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼ã€‚æ™‚é–“ã‚’ãŠã„ã¦è©¦ã—ã¦ãã ã•ã„ã€‚");
        } finally {
            document.getElementById('spinner').style.display = 'none';
        }
    }

    // --- ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ (localStorageä½¿ç”¨) ---
    function saveComment(id) {
        const input = document.getElementById(`comment-input-${id}`);
        const comment = input.value.trim();
        if (comment) {
            localStorage.setItem(id, comment);
            loadComment(id); // è¡¨ç¤ºã‚’æ›´æ–°
            input.value = ''; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
        }
    }

    function loadComment(id) {
        const display = document.getElementById(`comment-display-${id}`);
        const saved = localStorage.getItem(id);
        if (saved) {
            display.innerHTML = `<div class="saved-comment">${saved.replace(/\n/g, '<br>')}</div>`;
        } else {
            display.innerHTML = '<div class="no-comment">ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        }
    }

    fetchShrines(); // åˆæœŸãƒ­ãƒ¼ãƒ‰
</script>
</body>
</html>
